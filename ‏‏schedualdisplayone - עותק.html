<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <h2 style="text-align: center;color:#806092;">Group Scheduling</h2>
    <div style="display:flex;width:100%;">
        <div style="width:50%;background:#806092;display:flex">
           <div style="border-right: 1px solid white;width:50%">
            <div class="groupNames" style="padding:20px;">
                <h2 style="color:white;font-size:30px;">Please Add A Group Name</h2>
                <input name="groupName" value="" id="groupName">
            </div>
             <div class="schedules" style="padding:20px;background:#806092;"></div>
             <div style="background:#806092;padding:20px;">
                <br><br>
                <button id="" >Set Schedule</button> <br>  
              
                <h4 style="color:green" id="result"></h3>   
                <h4 style="color:red" id="error"></h3> 
            </div>
           </div>
           <div id="scheduleList" style="width:50%;padding:20px;text-align:center;">
            <div><h2 style="color:white;font-size:30px;">Schedule List</h2></div>
             
           </div>
           
        </div>
        
        <div style="width:50%;height:100%;background:white;">
            <div class="rooms" style="padding:20px;display:flex;flex-wrap: wrap;">
                <p id="temp" style="color:#806092;font-size:30px;">Looking for Checked In Rooms</p>
               
               
               
               
            </div>
        </div>
       
    </div>
    
    
    
    
    
    
    

</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js" integrity="sha512-3j3VU6WC5rPQB4Ld1jnLV7Kd5xr+cq9avvhwqzbH/taCRNURoeEpoPBK9pDyeukwSxwRPJ8fDgvYXd6SkaZ2TA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script>
    var myAuthorization = 'Bearer ' 
    + 'eyJhbGciOiJSUzI1NiJ9.eyJpYXQiOjE2NzMyNjU0NzAsImlzcyI6IkF1dGhTZXJ2aWNlIiwiYXVkIjoicG9ydGFsIiwic3ViIjoidGVzdCBtZXNzYWdlIGFwaSIsImFjY291bnRJZCI6IjMwMTQ1OTI1MDUiLCJzZXNzaW9uSWQiOiIzMGE2M2NlYy01OTkxLTRiZTAtOGM3Ni02YmI2M2M5MzdkNzIiLCJhdXRoU2NvcGVJZCI6IjMwYTYzY2VjLTU5OTEtNGJlMC04Yzc2LTZiYjYzYzkzN2Q3MiIsImF1dGhTY29wZSI6InNpZCJ9.fe6-7PFqPP2D57w85dLBcieBR9BpSoa9KE3txtfp8gbv-K5_0n3eK8SwgTqfT3WSeDJUWBk9HCR0Kb-T-KFNLkCsO3g61IYSVM3qKODUltFWIeueaEt91tb6EMVjfXSxlM9b8T0JzAXLWkM1PfCE_HaNp6ZPZd2hZyVTywnq5LTeqm0VUwVEegMZhlrtwfZOo1juRkXJVlr0kLNUqwECzk0OT2yamFj9QeST8ePUM4uSBbyQTP7I20XrVygdPYQ3ccBs1rM4hnIUFy5NTQSW1Thgig-YCmaaflLhhyuktTE8KoPPRVYFtH0J89XLnmUt_qd6mENGk4ngekhze6n2aQ'
    var time = '';
    var defaltSchedule = '';
   
    //let checkoutDate = {};
  
    
    
    var time = '';
    var defaltSchedule = '';
    let displayesToDefalt = [];
    let displayToDefalt = {};
    let dispayToDefaltScreens = [];
    let dispayToDefaltClients = [];
    let indexOfDisplayesToDefalt = 0;
    let checkSystemChangeScreens = [];
    //let checkoutDate = {};
    
    function checkSystemChangeClients(){
        
    }
    
    function checkoutCheck(){
  
        for ( var s = 0, len = localStorage.length; s < len; ++s ) {
            displayToDefalt = JSON.parse(localStorage.getItem( localStorage.key( s ) ));
            displayesToDefalt.push(displayToDefalt);
        
           
        console.log(displayesToDefalt);
       //alert("stop");
        for (let i = 0; i < displayesToDefalt.length; i++) {
  
        if (displayesToDefalt[i]) {
                let currentTime = new Date().getTime();
                let checkoutTime = new Date(displayesToDefalt[i].checkoutTime).getTime();
                    if (checkoutTime <= currentTime) {
                        console.log("time to checkout group schedule");
                        /// ajax call set schedule to defalt
                       // console.log(displayesToDefalt[i].screens);
                       //dispayToDefaltScreens = displayesToDefalt[i].screens;
                       //dispayToDefaltClients = displayesToDefalt[i].clients;
                    //    if (dispayToDefaltClients.length >1) {
                        
                    //    } else {
                        
                    //    }
                      for (let n = 0; n < displayesToDefalt[i].clients.length; n++) {
                        data = {
                            contextId: "53080447",
                            clientId: displayesToDefalt[i].clients,
                            clientType: "tv",
                            currentScheduleId: displayesToDefalt[i].currentSchedule,
                            scheduleRuleSetId: "53080589"
                        };
                        console.log(data);
                        console.log(displayesToDefalt[i].screens + " " +displayesToDefalt[i].clients + " " + displayesToDefalt[i].currentSchedule);
                       // console.log(dispayToDefaltClients[i]);
                       // console.log(displayesToDefalt[i].currentSchedule);
                         $.ajax({
                        type: "PUT",
                        url: "https://api.thecloudportal.com/api/1/feature/screens/screens/" + displayesToDefalt[i].screens,
                        headers: {
                        Authorization: myAuthorization
                        },
                        contentType: "application/json",
                        dataType: 'json', 
                        data: JSON.stringify(data),
                        async: false,
                        success: function (resultAfterChange, status, xhr) {
                           
                              
                           

                                
                            
                        
                    
                        
                        console.log("success");
                        },
                        error: function (xhr, status, error) {
                            console.log("fail");
                        }
                         });
                        
                  }
                 // alert(displayesToDefalt[i].checkoutTime + " " +  displayesToDefalt[i].clients[0]);
                  displayesToDefalt.splice(displayesToDefalt[i],1);
                 // alert(window.localStorage.getItem(localStorage.key( s )));
                  window.localStorage.removeItem(localStorage.key( s ));
                 // console.log("done");
                       
                // displayesToDefalt = [];
                // displayToDefalt = {};  
                // dispayToDefaltScreens= [];
                // dispayToDefaltClients= [];
                    location.reload();
            
                 } else {
                     console.log("not yet");
                     displayesToDefalt = [];
                    displayToDefalt = {};  
                    dispayToDefaltScreens= [];
                    dispayToDefaltClients= [];
         }
          
        }
     
       
   }
 
                  
                    
           
           
                    console.log();
}
        
}
let groupSchedule = {};
let newScreens = [];
function storageParams(groupName,newCurrentScheduelIds,screens,clientsId,newCheckedRooms,newCheckoutDates){
   console.log(groupName,newCurrentScheduelIds,screens,clientsId,newCheckedRooms,newCheckoutDates);
   
   for ( var s = 0, len = localStorage.length; s < len; ++s ) {
            displayToDefalt = JSON.parse(localStorage.getItem( localStorage.key( s ) ));
            displayesToDefalt.push(displayToDefalt);

   }
   if (displayesToDefalt.length > 0) {
    newScreens = screens;
    for (let ds = 0; ds < displayesToDefalt.length; ds++) {
     
    if (newScreens.includes(displayesToDefalt[ds].screens)) {
        newScreens = newScreens.filter(function(el){
              return el !== displayesToDefalt[ds].screens;
            })
            
    }
   }
    if (newScreens.length > 0) {
        for (let a = 0; a < newScreens.length; a++) {

            
            
            groupSchedule = {
            groupName : groupName,
            checkoutTime : newCheckoutDates[a],
            currentSchedule : newCurrentScheduelIds[a],
            screens: newScreens[a],
            clients: clientsId[a],
            rooms: newCheckedRooms[a]
            }  


            console.log(groupSchedule);
            window.localStorage.setItem(groupName + a, JSON.stringify(groupSchedule));
            groupSchedule = {}; 



}   
    }
            
            // if (screens[ds] == displayesToDefalt[ds].screens) {
            //     alert("there is a schedule already set for screen room " + checkedRooms[ds] + " under the groupName " + groupName + ". are you shure you want to update this screen");
            //     console.log(screens[ds] + " " + displayesToDefalt[ds].screens);
            // } else{
            //     console.log(screens[ds] + " not  " + displayesToDefalt[ds].screens);
            // }
           
        
       
      
    
  
   } else {
    for (let a = 0; a < screens.length; a++) {

            
            
    groupSchedule = {
    groupName : groupName,
    checkoutTime : newCheckoutDates[a],
    currentSchedule : newCurrentScheduelIds[a],
    screens: screens[a],
    clients: clientsId[a],
    rooms: newCheckedRooms[a]
    }  


    console.log(groupSchedule);
    window.localStorage.setItem(groupName + a, JSON.stringify(groupSchedule));
    groupSchedule = {}; 



    }   
   }
 
    
    
  
         
      
    
    
  
   
  
   
//    groupSchedule = {
//    groupName : groupName,
//    checkoutTime : checkoutDate,
//    currentSchedule : newCurrentScheduelId,
//    screens: screens,
//    clients: arrClientId
//   }  
  
   
//    if(window.localStorage.getItem(groupSchedule.groupName !== null) ){
//        console.log("localstorage already exists");
       
//    }else {
//     console.log(groupSchedule);
//     window.localStorage.setItem(groupSchedule.groupName, JSON.stringify(groupSchedule));
       
       
      
//    }
   
};


console.log();
setInterval( function() {
   
   
   
   checkoutCheck();

}, 60000 );

////// displaying details on scheduled groups that are in local storage
var sheduelLists = []; 
for ( var s = 0, len = localStorage.length; s < len; ++s ) {
       if(localStorage.getItem( localStorage.key( s )) !== null){
        let sheduelList = JSON.parse(localStorage.getItem( localStorage.key( s ) ));
        sheduelLists.push(sheduelList);
        
        console.log(sheduelLists);
       }        
           
} 
var reorderSheduelLists = sheduelLists;
for (let i = 0; i < sheduelLists.length; i++) {
    // for (let r = 0; r < reorderSheduelLists.length; r++) {
    //     if(){

    //     }
        
    // }
    $("#scheduleList").append("<div style='color: white;padding:20px;'><p>shcedule for group " +
         sheduelLists[i].groupName + 
         " Room Number " +
          sheduelLists[i].rooms +
          " will end at <br/>" +
           sheduelLists[i].checkoutTime +
            "<br/></p></div>" );
    
}



    
           
    

   

    ///////// get Schedule Rule Set
    let schedule = '';
    $.ajax({
    type: "GET",
    url: "https://api.thecloudportal.com/api/1/feature/screens/schedule-rule-sets?contextId=53080447" ,
    headers: {
    Authorization: myAuthorization
     },
    contentType: "application/json",
     dataType: 'json',
    
     async: false,
     success: function (result0, status, xhr) {
        console.log(result0);
        
        for(var i = 0; i<result0.length; i++){
            if (result0[i].name !== 'Default') {
                schedule = '<div ><p style="color:#ffffff;font-size:30px;" >Schedule ' +
                      result0[i].name +
                       '</p ><input name=' +
                        result0[i].name +
                        ' class="sched" type="checkbox" value=' +
                         result0[i].id +
                          ' id=' + result0[i].id +
                           '></div>';
                $(".schedules").append(schedule);
            }
            
         };
    
                
     },
     error: function (xhr, status, error) {
     alert(error);
     }

    });
    /////////get guests
    let checkoutDate = '';
    let checkedRooms = [];
    let newCheckedRooms = [];
    let newCurrentScheduelIds = [];
    let currentScheduleId = '';
    let groupName = '';
    $.ajax({
   
   type: "GET",
   url: "https://api.thecloudportal.com/api/1/feature/hospitality/guest-accounts?contextId=53080447",
   headers: {
       Authorization: myAuthorization
   },
   dataType: 'json',
   async: false,
   success: function (result1, status, xhr) {
       console.log(result1);
        let roomAcountId = '';
        let roomNumber = '';
        let roomNumbers = [];
        let res = '';
        
     
     let locations = [];
        for(var i = 0; i<result1.length; i++){

        ////////get locations
           
        $.ajax({
                type: "GET",
                url: "https://api.thecloudportal.com/api/1/feature/context-locations/locations/" + result1[i].locationId,
                headers: {
                Authorization: myAuthorization
                 },
                dataType: 'json',
                async: false,
                success: function (result2, status, xhr) {
                    console.log(result2);

                $('#temp').hide();
                roomNumber = result2.ref;
                res = '<div style="display:flex;flex: 1 1 10%;"><p style="color:#806092;font-size:30px; border:2px solid #806092" >room ' +
                      roomNumber +
                       '</p ><input style="width:20px;" class="room" data-clientId="" name=' +
                        result1[i].checkOutDate +
                         ' type="checkbox" value=' +
                          result1[i].locationId + 
                          ' id=' + roomNumber + '></div>';
                roomNumbers.push(roomNumber);
                $(".rooms").append(res); 
                
               
              
                
                },
                 error: function (xhr, status, error) {
                 alert(error);
                }
               
            });
            /////////
            
            
           
        };
        $('.sched').on('change', function() {
             $('.sched').not(this).prop('checked', false);  
        });
        ////////get clients
        let arrLocationId = [];
        let arrClientId = [];
        let arrClientId2 = [];
        let screens = [];
        let checkoutDates = [];
        clientsId = [];
        
       // let currentScheduleId = '';
        $.ajax({
                type: "GET",
                url: "https://api.thecloudportal.com/api/1/feature/clients/clients?contextId=53080447",
                headers: {
                Authorization: myAuthorization
                 },
                 contentType: "application/json",
                 dataType: 'json',
                 async: false,
                success: function (result3, status, xhr) {
                   
                    console.log(result3);
                    $('button').click(function(){
                    groupName = $("#groupName").val();
                       
                    $(".room:checkbox:checked").each(function(){
                      
                    checkedRooms.push($(this).attr("id")); 
                    });
                    
                    $(".room:checkbox:checked").each(function(){
                      
                        checkoutDates.push($(this).attr("name")); 
                    });
                    if ($(".sched:checkbox:checked").val() && $(".room:checkbox:checked").val()) {
                    
                    $(".room:checkbox:checked").each(function(){
                      
                        arrLocationId.push($(this).val()); 
                    });
                    //console.log(arrLocationId);
                    for(var i = 0; i<result3.length; i++){
                       // console.log(result3[i].locationId);
                       // console.log(arrLocationId[i]);
                      if (arrLocationId.includes(result3[i].locationId) ) {
                        
                        arrClientId.push(result3[i].id);
                        console.log();

                       }
                        
                    }
                 /////// get screens
                 $.ajax({
                type: "GET",
                url: "https://api.thecloudportal.com/api/1/feature/screens/screens?contextId=53080447",
                headers: {
                Authorization: myAuthorization
                 },
                 contentType: "application/json",
                 dataType: 'json',
                 async: false,
                success: function (result4, status, xhr) {
                    console.log(result4);

                    for(var i = 0; i<result4.length; i++){
                        //console.log(result4[i].clientId);
                        
                      if (arrClientId.includes(result4[i].clientId)) {
                        arrClientId2.push(result4[i].clientId);
                        
                        
                        screens.push(result4[i].id); ///// result4[i].id

                        $('.room:checkbox:checked').data("clientId",result4[i].clientId);
                        console.log($('.room:checkbox:checked').data('clientId'));
                       

                       
                            currentScheduleId = result4[i].currentScheduleId;
                        
                       
                        //currentScheduleId.push(result4[i].currentScheduleId);
                        console.log(currentScheduleId);

                       }

                    }

                    
                    ///// put new schedual in screens
                    let data = {};
                    let data2 = {};
                    //var date= newDate();
                    
    for ( var s = 0, len = localStorage.length; s < len; ++s ) {
        displayToDefalt = JSON.parse(localStorage.getItem( localStorage.key( s ) ));
        displayesToDefalt.push(displayToDefalt);

   }
   newCheckedRooms = checkedRooms;
   console.log(displayesToDefalt);
   newScreens = screens;
   newArrClientId2  =  arrClientId2;
    
   newCheckoutDates =   checkoutDates;
   if (displayesToDefalt.length > 0) {
  
    console.log(newCheckedRooms);
    
    //newCurrentScheduelId = currentScheduleId;
    for (let ds = 0; ds < displayesToDefalt.length; ds++) {
     
    
        newScreens = newScreens.filter(function(el){
              return el !== displayesToDefalt[ds].screens;
            });
        newArrClientId2 = newArrClientId2.filter(function(el){
              return el !== displayesToDefalt[ds].clients;
            });
        
            newCheckedRooms = newCheckedRooms.filter(function (el) {
                return el !== displayesToDefalt[ds].rooms;
            });
            newCheckoutDates = checkoutDates.filter(function (el) {
                return el !== displayesToDefalt[ds].checkoutTime;
            });
            // $(".room:checkbox:checked").each(function(){
            //     console.log($(this).data("clientId"));
            //     console.log(displayesToDefalt[ds].clients);
            //           if($(this).data("clientId") == displayesToDefalt[ds].clients){
            //             newCheckedRooms.push($(this).attr("id"));  
                        
            //           }
                   
            //  });
            
    
   }
   console.log(newCheckedRooms);

    if (newScreens.length > 0) {
        for (let i = 0; i < newScreens.length; i++) {
            // console.log(screens);
            // console.log(currentScheduleId);
            // console.log($(".sched:checkbox:checked").val());
            // console.log(arrClientId2);
    data = {
    "contextId": "53080447",
    "clientId": newArrClientId2[i],
    "clientType": "tv",
    "currentScheduleId": currentScheduleId,
    "scheduleRuleSetId":  $(".sched:checkbox:checked").val()
    }
    $.ajax({
    type: "PUT",
    url: "https://api.thecloudportal.com/api/1/feature/screens/screens/" + newScreens[i],
    headers: {
    Authorization: myAuthorization
     },
    contentType: "application/json",
    dataType: 'json',
    data: JSON.stringify(data),
    async: false,
    success: function (result5, status, xhr) {
    console.log(result5);
    //alert("room " + roomNumbers[i] + " was updated to Schedule " + $(".sched:checkbox:checked").attr("name"));
    

/////////////get current schedule after change from screens

   
       
       
        
        let checkoutDate = '';
        
         //// need to make it input checked of class groups
        clientsId = newArrClientId2;
            $.ajax({
            type: "GET",
            url: "https://api.thecloudportal.com/api/1/feature/screens/screens?contextId=53080447",
            headers: {
            Authorization: myAuthorization
             },
            contentType: "application/json",
            dataType: 'json', 
            async: false,
            success: function (resultAfterChange, status, xhr) {
            console.log(resultAfterChange);
            for (var ncs = 0; ncs < resultAfterChange.length; ncs++) {
                if(resultAfterChange[ncs].id == screens[i]){
                    newCurrentScheduelIds.push(resultAfterChange[ncs].currentScheduleId);
                };
                
            }
            
            
            

           },
             error: function (xhr, status, error) {
             console.log("error getting current schedule");
            }
        });
       
        
  

    



    },
    error: function (xhr, status, error) {
    alert("somthing went wrong with screens");
    }





});
            
           



        }   
    }
            
           
        
       
      
    
  
   }else{
    for(var i = 0; i<screens.length; i++){

   
console.log(screens);
console.log(currentScheduleId);
console.log($(".sched:checkbox:checked").val());
console.log(arrClientId2);

    data = {
    "contextId": "53080447",
    "clientId": arrClientId2[i],
    "clientType": "tv",
    "currentScheduleId": currentScheduleId,
    "scheduleRuleSetId":  $(".sched:checkbox:checked").val()
    }
    $.ajax({
    type: "PUT",
    url: "https://api.thecloudportal.com/api/1/feature/screens/screens/" + screens[i],
    headers: {
    Authorization: myAuthorization
     },
    contentType: "application/json",
    dataType: 'json',
    data: JSON.stringify(data),
    async: false,
    success: function (result5, status, xhr) {
    console.log(result5);
    //alert("room " + roomNumbers[i] + " was updated to Schedule " + $(".sched:checkbox:checked").attr("name"));
    

/////////////get current schedule after change from screens

   
       
       
        
        let checkoutDate = '';
        
         //// need to make it input checked of class groups
        clientsId = arrClientId2;
            $.ajax({
            type: "GET",
            url: "https://api.thecloudportal.com/api/1/feature/screens/screens?contextId=53080447",
            headers: {
            Authorization: myAuthorization
             },
            contentType: "application/json",
            dataType: 'json', 
            async: false,
            success: function (resultAfterChange, status, xhr) {
            console.log(resultAfterChange);
            for (var ncs = 0; ncs < resultAfterChange.length; ncs++) {
                if(resultAfterChange[ncs].id == screens[i]){
                    newCurrentScheduelIds.push(resultAfterChange[ncs].currentScheduleId);
                };
                
            }
            
                                
                               /// location.reaload();
            
                
            
            
            

           },
             error: function (xhr, status, error) {
             console.log("error getting current schedule");
            }
        });
       
        
  

    



    },
    error: function (xhr, status, error) {
    alert("somthing went wrong with screens");
    }





});

  

}
   }
     
       
                 
                 
                              

                    
      
             
                
                },
                 error: function (xhr, status, error) {
                alert(error);
                }
               
            


                });
            } else {
        alert("please choose atleast 1 rooms and 1 schedule");
            } 
            
          
                               
               
               
            if(newCheckedRooms.length > 0 && newCheckedRooms.length < checkedRooms.length){
                storageParams(groupName,newCurrentScheduelIds,newScreens,clientsId,newCheckedRooms,newCheckoutDates);
                console.log(groupName,newCurrentScheduelIds,newScreens,clientsId,newCheckedRooms,newCheckoutDates);
                for (let i = 0; i < newCheckedRooms.length; i++) {
                    checkedRooms = checkedRooms.filter(function (el) {
                    return el !== newCheckedRooms[i];
                    });
                    
                }
                
                    alert("Rooms " + newCheckedRooms.toString() +
                     " where updated to " +
                      $(".sched:checkbox:checked").attr("name") +
                       " schedule." + " Please note that rooms " +
                        checkedRooms + " already have a schedule");
                    console.log(checkedRooms, newCheckedRooms);
                    location.reload();
            }else if(newCheckedRooms.length > 0  && newCheckedRooms.length == checkedRooms.length){
                storageParams(groupName,newCurrentScheduelIds,newScreens,clientsId,newCheckedRooms,newCheckoutDates);
                alert("Rooms " + newCheckedRooms.toString() +
                 " where updated to " +
                  $(".sched:checkbox:checked").attr("name") +
                   " schedule." + "nnnnnnnnnnnnnnnnnnnnnnn");
                location.reload();
            }else{
                alert(checkedRooms + " already have a shcedule");
                location.reload();
            }
                
           // location.reload();
            
            //     console.log(checkedRooms, newCheckedRooms);
            
            
            
                    });
                    
/////////////////////////////////////////////////////////////

                },
                 error: function (xhr, status, error) {
                alert("somthing went wrong");
                }
               
            


        });
        
         arrLocationId = [];
         arrClientId = [];
         arrClientId2 = [];
         screens = [];
         currentScheduleId = '';
         checkedRooms = [];
        


        
   },
   error: function (xhr, status, error) {
        alert(error);
   }
  
});


</script>
</html>